<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de Grilla por Rubro</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
    }
    #map { width: 100%; height: calc(100vh - 120px); }
    .panel {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .panel h2 {
      margin: 0 0 10px 0;
      font-size: 1.5rem;
    }
    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    select, button {
      font-size: 14px;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    select {
      background: white;
      color: #333;
      min-width: 200px;
    }
    button {
      background: #28a745;
      color: white;
      font-weight: 600;
      transition: background 0.3s;
    }
    button:hover { background: #218838; }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      font-size: 14px;
    }
    .stat { font-weight: 600; }
    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .legend-title {
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
      font-size: 13px;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border: 1px solid #333;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h2>üó∫Ô∏è Configurador de Grillas por Rubro</h2>
    <div class="controls">
      <div>
        <label>Rubro:</label>
        <select id="rubroSelect"></select>
      </div>
      <button id="btnGuardar" disabled>üíæ Guardar Estados</button>
      <button id="btnCiclar">üîÑ Ciclar Estado (Click)</button>
      <button id="btnCopiar" style="background: #17a2b8;">üìã Copiar a Otros Rubros</button>
      <label style="display: flex; align-items: center; gap: 5px; background: white; color: #333; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
        <input type="checkbox" id="chkMostrarCodigos" style="cursor: pointer;">
        <span>Mostrar c√≥digos</span>
      </label>
    </div>
    <div class="stats">
      <span class="stat">Total: <span id="statTotal">0</span></span>
      <span class="stat" style="color: #ffc107;">‚¨§ Pendientes: <span id="statPendiente">0</span></span>
      <span class="stat" style="color: #28a745;">‚¨§ Seleccionadas: <span id="statSeleccionado">0</span></span>
      <span class="stat" style="color: #17a2b8;">‚¨§ Revisar: <span id="statRevisar">0</span></span>
      <span class="stat" style="color: #dc3545;">‚¨§ Descartadas: <span id="statDescartado">0</span></span>
      <span class="stat" style="color: #6c757d;">‚¨§ Buscadas: <span id="statBuscada">0</span></span>
    </div>
  </div>

  <div id="map"></div>

  <div class="legend">
    <div class="legend-title">Estado de Celdas</div>
    <div class="legend-item">
      <div class="legend-color" style="background: #ffc107;"></div>
      <span>Pendiente</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #28a745;"></div>
      <span>Seleccionada</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #17a2b8;"></div>
      <span>Revisar</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #dc3545;"></div>
      <span>Descartada</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #6c757d;"></div>
      <span>Ya buscada</span>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const grillaNombre = 'conurbano_sur_v1_extendida';
    const colores = {
      pendiente: '#ffc107',
      seleccionado: '#28a745',
      revisar: '#17a2b8',
      descartado: '#dc3545',
      buscada: '#6c757d'
    };

    const map = L.map('map').setView([-34.75, -58.4], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    const rectangulos = new Map();
    let rubros = [];
    let rubroActual = null;
    let cambiosPendientes = new Map(); // grilla_id -> nuevo_estado
    let modoCiclo = true;

    async function cargarRubros() {
      try {
        const res = await fetch('/api/rubros/rubros-activos');
        rubros = await res.json();
        
        const selector = document.getElementById('rubroSelect');
        selector.innerHTML = '';
        
        rubros.forEach(r => {
          const option = document.createElement('option');
          option.value = r.id;
          option.textContent = r.nombre || r.keyword_google;
          selector.appendChild(option);
        });
        
        if (rubros.length > 0) {
          rubroActual = rubros[0].id;
          await cargarGrilla(rubroActual);
          
          selector.addEventListener('change', async () => {
            if (cambiosPendientes.size > 0) {
              if (!confirm('Hay cambios sin guardar. ¬øDesea descartarlos?')) {
                selector.value = rubroActual;
                return;
              }
              cambiosPendientes.clear();
              document.getElementById('btnGuardar').disabled = true;
            }
            rubroActual = selector.value;
            await cargarGrilla(rubroActual);
          });
        }
      } catch (error) {
        alert('Error al cargar rubros: ' + error.message);
        console.error(error);
      }
    }

    async function cargarGrilla(rubroId) {
      try {
        const res = await fetch(`/api/grillas/estados/${grillaNombre}/${rubroId}`);
        const celdas = await res.json();

        // Obtener celdas ya buscadas
        const rubro = rubros.find(r => r.id == rubroId);
        const keyword = rubro ? rubro.keyword_google : '';
        
        let yaBuscadas = [];
        if (keyword) {
          const res2 = await fetch(`/api/grillas/celdas-ya-buscadas?keyword=${encodeURIComponent(keyword)}&grilla_nombre=${encodeURIComponent(grillaNombre)}`);
          yaBuscadas = await res2.json();
        }

        rectangulos.clear();
        map.eachLayer(layer => {
          if (layer instanceof L.Rectangle) map.removeLayer(layer);
        });

        celdas.forEach(celda => {
          const bounds = [[celda.lat1, celda.lng1], [celda.lat2, celda.lng2]];
          let estado = celda.estado;
          
          // Si ya fue buscada, marcarla como buscada
          const yaBuscada = yaBuscadas.includes(celda.codigo);
          
          const color = yaBuscada ? colores.buscada : colores[estado];
          const rect = L.rectangle(bounds, {
            color, 
            fillColor: color, 
            weight: 1, 
            fillOpacity: 0.4
          }).addTo(map);
          
          rect.estado = estado;
          rect.estadoOriginal = estado;
          rect.codigo = celda.codigo;
          rect.grillaId = celda.grilla_id;
          rect.yaBuscada = yaBuscada;
          
          // Agregar tooltip on hover
          const estadoTexto = yaBuscada ? 'Ya buscada' : estado.charAt(0).toUpperCase() + estado.slice(1);
          rect.bindTooltip(`C√≥digo: ${celda.codigo}<br>Estado: ${estadoTexto}`, {
            sticky: true,
            opacity: 0.9
          });
          
          rect.on('click', () => {
            if (rect.yaBuscada) {
              alert('Esta celda ya fue buscada para este rubro');
              return;
            }
            
            if (modoCiclo) {
              ciclarEstado(rect);
            }
          });
          
          rectangulos.set(celda.grilla_id, rect);
        });

        actualizarEstadisticas();
        
        // Habilitar bot√≥n guardar siempre que hay una grilla cargada
        document.getElementById('btnGuardar').disabled = false;
      } catch (error) {
        alert('Error al cargar grilla: ' + error.message);
        console.error(error);
      }
    }

    function ciclarEstado(rect) {
      const ciclo = ['pendiente', 'seleccionado', 'revisar', 'descartado'];
      const indiceActual = ciclo.indexOf(rect.estado);
      const nuevoEstado = ciclo[(indiceActual + 1) % ciclo.length];
      
      rect.estado = nuevoEstado;
      const color = colores[nuevoEstado];
      rect.setStyle({ color, fillColor: color });
      
      // Actualizar tooltip
      const estadoTexto = nuevoEstado.charAt(0).toUpperCase() + nuevoEstado.slice(1);
      rect.setTooltipContent(`C√≥digo: ${rect.codigo}<br>Estado: ${estadoTexto}`);
      
      // Manejar label si el checkbox est√° activo
      const mostrarCodigos = document.getElementById('chkMostrarCodigos').checked;
      if (rect.label) {
        map.removeLayer(rect.label);
        rect.label = null;
      }
      
      if (mostrarCodigos && nuevoEstado === 'seleccionado') {
        const center = rect.getBounds().getCenter();
        rect.label = L.marker(center, {
          icon: L.divIcon({
            className: 'codigo-label',
            html: `<div style="
              background: rgba(40, 167, 69, 0.9);
              color: white;
              padding: 2px 6px;
              border-radius: 3px;
              font-size: 11px;
              font-weight: bold;
              white-space: nowrap;
              border: 1px solid white;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            ">${rect.codigo}</div>`,
            iconSize: null
          }),
          interactive: false
        }).addTo(map);
      }
      
      cambiosPendientes.set(rect.grillaId, nuevoEstado);
      document.getElementById('btnGuardar').disabled = false;
      
      actualizarEstadisticas();
    }

    function actualizarEstadisticas() {
      const stats = {
        total: rectangulos.size,
        pendiente: 0,
        seleccionado: 0,
        revisar: 0,
        descartado: 0,
        buscada: 0
      };

      rectangulos.forEach(rect => {
        if (rect.yaBuscada) {
          stats.buscada++;
        } else {
          stats[rect.estado]++;
        }
      });

      document.getElementById('statTotal').textContent = stats.total;
      document.getElementById('statPendiente').textContent = stats.pendiente;
      document.getElementById('statSeleccionado').textContent = stats.seleccionado;
      document.getElementById('statRevisar').textContent = stats.revisar;
      document.getElementById('statDescartado').textContent = stats.descartado;
      document.getElementById('statBuscada').textContent = stats.buscada;
    }

    document.getElementById('btnCiclar').addEventListener('click', () => {
      modoCiclo = !modoCiclo;
      const btn = document.getElementById('btnCiclar');
      btn.textContent = modoCiclo ? 'üîÑ Ciclar Estado (Click)' : 'üëÜ Modo Click Simple';
      btn.style.background = modoCiclo ? '#28a745' : '#6c757d';
    });

    document.getElementById('btnGuardar').addEventListener('click', async () => {
      const btn = document.getElementById('btnGuardar');
      btn.disabled = true;
      btn.textContent = '‚è≥ Guardando...';

      try {
        // Guardar solo los estados NO-pendientes (seleccionado, revisar, descartado)
        const actualizaciones = [];
        rectangulos.forEach(rect => {
          if (!rect.yaBuscada && rect.estado !== 'pendiente') {
            actualizaciones.push({
              grilla_id: rect.grillaId,
              rubro_id: parseInt(rubroActual),
              estado: rect.estado
            });
          }
        });

        if (actualizaciones.length === 0) {
          alert('No hay cambios que guardar');
          btn.disabled = false;
          btn.textContent = 'üíæ Guardar Estados';
          return;
        }

        const res = await fetch('/api/grillas/estados/batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ actualizaciones })
        });

        if (!res.ok) throw new Error('Error al guardar');

        cambiosPendientes.clear();
        
        // Actualizar estados originales
        rectangulos.forEach(rect => {
          rect.estadoOriginal = rect.estado;
        });

        btn.textContent = '‚úÖ Guardado!';
        setTimeout(() => {
          btn.textContent = 'üíæ Guardar Estados';
        }, 2000);
      } catch (error) {
        alert('Error al guardar: ' + error.message);
        btn.textContent = '‚ùå Error';
        btn.disabled = false;
      }
    });

    document.getElementById('btnCopiar').addEventListener('click', async () => {
      // Crear modal para seleccionar rubros destino
      const rubrosDestino = rubros.filter(r => r.id != rubroActual);
      
      if (rubrosDestino.length === 0) {
        alert('No hay otros rubros disponibles');
        return;
      }

      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      const contenido = document.createElement('div');
      contenido.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
      `;

      const rubroActualNombre = rubros.find(r => r.id == rubroActual).nombre;

      contenido.innerHTML = `
        <h3 style="margin-top: 0;">Copiar configuraci√≥n de "${rubroActualNombre}"</h3>
        <p style="color: #666; margin-bottom: 20px;">
          Selecciona los rubros a los que quieres copiar esta configuraci√≥n:
        </p>
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
          ${rubrosDestino.map(r => `
            <label style="display: block; padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;">
              <input type="checkbox" value="${r.id}" style="margin-right: 10px;">
              ${r.nombre}
            </label>
          `).join('')}
        </div>
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
          <button id="btnCancelar" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Cancelar
          </button>
          <button id="btnConfirmar" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Copiar Configuraci√≥n
          </button>
        </div>
      `;

      modal.appendChild(contenido);
      document.body.appendChild(modal);

      // Event listeners del modal
      contenido.querySelector('#btnCancelar').addEventListener('click', () => {
        modal.remove();
      });

      contenido.querySelector('#btnConfirmar').addEventListener('click', async () => {
        const checkboxes = contenido.querySelectorAll('input[type="checkbox"]:checked');
        const rubrosSeleccionados = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (rubrosSeleccionados.length === 0) {
          alert('Selecciona al menos un rubro');
          return;
        }

        const btnConfirmar = contenido.querySelector('#btnConfirmar');
        btnConfirmar.disabled = true;
        btnConfirmar.textContent = '‚è≥ Copiando...';

        // Crear barra de progreso
        const progressDiv = document.createElement('div');
        progressDiv.style.cssText = 'margin-top: 15px; text-align: center;';
        progressDiv.innerHTML = `
          <div style="background: #f0f0f0; border-radius: 10px; height: 20px; overflow: hidden; margin-bottom: 10px;">
            <div id="progressBar" style="background: linear-gradient(to right, #4CAF50, #45a049); height: 100%; width: 0%; transition: width 0.3s;"></div>
          </div>
          <div id="progressText">Preparando...</div>
        `;
        btnConfirmar.parentElement.appendChild(progressDiv);

        try {
          // Obtener SOLO las celdas seleccionadas del rubro origen
          const estadosActuales = [];
          rectangulos.forEach(rect => {
            if (!rect.yaBuscada && rect.estado === 'seleccionado') {
              estadosActuales.push({
                grilla_id: rect.grillaId,
                estado: rect.estado
              });
            }
          });

          if (estadosActuales.length === 0) {
            alert('No hay celdas seleccionadas para copiar');
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'Copiar Configuraci√≥n';
            progressDiv.remove();
            return;
          }

          progressDiv.querySelector('#progressText').textContent = 
            `Copiando ${estadosActuales.length} celdas a ${rubrosSeleccionados.length} rubros...`;

          // Crear actualizaciones para cada rubro destino
          const actualizaciones = [];
          rubrosSeleccionados.forEach(rubroId => {
            estadosActuales.forEach(item => {
              actualizaciones.push({
                grilla_id: item.grilla_id,
                rubro_id: rubroId,
                estado: item.estado
              });
            });
          });

          progressDiv.querySelector('#progressBar').style.width = '50%';
          progressDiv.querySelector('#progressText').textContent = 
            `Enviando ${actualizaciones.length} actualizaciones...`;

          const res = await fetch('/api/grillas/estados/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ actualizaciones })
          });

          if (!res.ok) throw new Error('Error al copiar');

          progressDiv.querySelector('#progressBar').style.width = '100%';
          progressDiv.querySelector('#progressText').textContent = '‚úÖ ¬°Copiado exitosamente!';
          
          setTimeout(() => {
            modal.remove();
          }, 1500);
          alert(`‚úÖ Configuraci√≥n copiada exitosamente a ${rubrosSeleccionados.length} rubro(s)`);
        } catch (error) {
          alert('Error al copiar: ' + error.message);
          btnConfirmar.disabled = false;
          btnConfirmar.textContent = 'Copiar Configuraci√≥n';
        }
      });
    });

    // Checkbox para mostrar/ocultar c√≥digos
    document.getElementById('chkMostrarCodigos').addEventListener('change', (e) => {
      const mostrar = e.target.checked;
      
      rectangulos.forEach(rect => {
        // Remover label existente si hay
        if (rect.label) {
          map.removeLayer(rect.label);
          rect.label = null;
        }
        
        // Si est√° marcado Y la celda est√° seleccionada, mostrar label
        if (mostrar && rect.estado === 'seleccionado' && !rect.yaBuscada) {
          const center = rect.getBounds().getCenter();
          rect.label = L.marker(center, {
            icon: L.divIcon({
              className: 'codigo-label',
              html: `<div style="
                background: rgba(40, 167, 69, 0.9);
                color: white;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 11px;
                font-weight: bold;
                white-space: nowrap;
                border: 1px solid white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
              ">${rect.codigo}</div>`,
              iconSize: null
            }),
            interactive: false
          }).addTo(map);
        }
      });
    });

    // Iniciar
    cargarRubros();
  </script>
</body>
</html>
